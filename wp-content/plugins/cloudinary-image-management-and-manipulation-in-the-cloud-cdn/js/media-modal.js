!function(){if(wp.media){wp.media.events.on("editor:image-edit",(function(e){e.metadata.cldoverwrite=null,e.image.className.split(" ").indexOf("cld-overwrite")>=0&&(e.metadata.cldoverwrite="true")})),wp.media.events.on("editor:image-update",(function(e){var t=e.image.className.split(" ");e.metadata.cldoverwrite&&-1===t.indexOf("cld-overwrite")?t.push("cld-overwrite"):!e.metadata.cldoverwrite&&t.indexOf("cld-overwrite")>=0&&delete t[t.indexOf("cld-overwrite")],e.image.className=t.join(" ")}));var e=null,t=wp.media.string.props;wp.media.string.props=function(i,a){return i.cldoverwrite&&(i.classes=["cld-overwrite"],e=!0),t(i,a)},wp.media.post=function(t,i){if("send-attachment-to-editor"===t){var a=wp.media.editor.get().state().get("selection").get(i.attachment);a.attributes.transformations&&(i.attachment.transformations=a.attributes.transformations),(i.html.indexOf("cld-overwrite")>-1||!0===e)&&(i.attachment.cldoverwrite=!0,e=null)}return wp.ajax.post(t,i)};var i=wp.media.view.MediaFrame.Select,a=wp.media.view.MediaFrame.Post,r=wp.media.view.MediaFrame.ImageDetails,n=wp.media.view.MediaFrame.VideoDetails,o=wp.media.view.Settings.AttachmentDisplay,d=wp.media.View.extend({tagName:"div",className:"cloudinary-widget",template:wp.template("cloudinary-dam"),active:!1,toolbar:null,frame:null,ready:function(){var e=this.controller,t=this.model.get("selection"),i=this.model.get("library"),a=wp.media.model.Attachment;if(CLDN.mloptions.multiple=e.options.multiple,this.cid!==this.active){if(CLDN.mloptions.inline_container="#cloudinary-dam-"+e.cid,1===t.length){var r=a.get(t.models[0].id);void 0!==r.attributes.public_id&&(CLDN.mloptions.asset={resource_id:r.attributes.public_id})}else CLDN.mloptions.asset=null;try{CLDN.mloptions.folder||(CLDN.mloptions.folder={path:""});var n=t.props.attributes.type;CLDN.mloptions.folder.resource_type=Array.isArray(n)?n[0]:n}catch(e){}window.ml=cloudinary.openMediaLibrary(CLDN.mloptions,{insertHandler:function(r){for(var n=0;n<r.assets.length;n++){var o=r.assets[n];wp.media.post("cloudinary-down-sync",{nonce:CLDN.nonce,asset:o}).done((function(r){var n=function(e,t){e.uploading=!1,t.set(e),wp.Uploader.queue.remove(t),0===wp.Uploader.queue.length&&wp.Uploader.queue.reset()};if(void 0!==r.resync&&r.resync.forEach((function(e){a.get(e.id).set(e)})),void 0!==r.fetch){var o=a.get(r.attachment_id);o.set(r),i.add(o),wp.Uploader.queue.add(o),wp.ajax.send({url:r.fetch,beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",CLDN.nonce)},data:{src:r.url,filename:r.filename,attachment_id:r.attachment_id,transformations:r.transformations}}).done((function(e){var t=a.get(e.id);n(e,t)})).fail((function(e){n(r,o),i.remove(o),t.remove(o),"string"==typeof e?alert(e):500===e.status&&alert("HTTP error.")}))}else{var d=a.get(r.id);d.set(r),t.add(d)}0===wp.Uploader.queue.length&&wp.Uploader.queue.reset(),e.content.mode("browse")}))}}},document.querySelectorAll(".dam-cloudinary")[0])}return this.active=this.cid,this}}),s=function(e){var t={bindHandlers:function(){e.prototype.bindHandlers.apply(this,arguments),this.on("content:render:cloudinary",this.cloudinaryContent,this)},browseRouter:function(t){e.prototype.browseRouter.apply(this,arguments),t.set({cloudinary:{text:"Cloudinary",priority:60}})},cloudinaryContent:function(){this.$el.addClass("hide-toolbar");var e=this.state(),t=new d({controller:this,model:e}).render();this.content.set(t)}};return t};wp.media.view.MediaFrame.Select=i.extend(s(i)),wp.media.view.MediaFrame.Post=a.extend(s(a)),wp.media.view.MediaFrame.ImageDetails=r.extend(s(r)),wp.media.view.MediaFrame.VideoDetails=n.extend(s(n)),wp.media.view.Settings.AttachmentDisplay=o.extend((l=o,{initialize:function(){l.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:cldoverwrite",this.handleOverwrite)},handleOverwrite:function(e){var t=this.options.attachment.attributes.sizes;for(var i in t){var a=new URL(t[i].url);e.attributes.cldoverwrite?a.searchParams.set("cld_overwrite",!0):a.searchParams.delete("cld_overwrite"),this.options.attachment.attributes.sizes[i].url=a.href}}}))}var l}();